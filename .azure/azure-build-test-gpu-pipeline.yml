trigger: none
pr: none

stages:
  - stage: 'Build'
    jobs:
      - job: Docker
        timeoutInMinutes: 30
        pool: "Monai VMSS"
        steps:
          - script: |
              sudo killall apt apt-get | echo killing existing apt
              sudo rm -rf /var/lib/apt/lists/lock
              sudo rm -rf /var/cache/apt/archives/lock
              sudo rm -rf /var/lib/dpkg/lock
              sudo dpkg --configure -a
              sudo apt-get update --fix-missing -y
              sudo apt-get install -f -y
            displayName: 'Fix Lock (Hack)'
          - bash: |
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
              sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu  $(lsb_release -cs)  stable"
              sudo apt-get update
              sudo apt-get install docker-ce
            displayName: 'Install dependencies'
          - bash: |
              DOCKER_BUILDKIT=1 docker build -t projectmonai/monailabel:latest -f Dockerfile .
            displayName: 'Build Latest Docker'
          - bash: |
              docker run --gpus all --rm -ti --ipc=host --net=host -v $(pwd):/workspace projectmonai/monailabel:latest /workspace/runtests.sh --net
            displayName: 'Verify Latest Docker'
